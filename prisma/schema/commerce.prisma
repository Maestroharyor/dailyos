// Commerce Module Enums
enum ProductStatus {
  draft
  active
  archived
}

enum OrderStatus {
  pending
  confirmed
  processing
  completed
  cancelled
  refunded
}

enum OrderSource {
  walk_in
  storefront
  manual
}

enum PaymentMethod {
  cash
  card
  transfer
  pos
  other
}

enum MovementType {
  stock_in
  stock_out
  adjustment
  return_stock
  sale
  refund
}

enum MovementReferenceType {
  order
  purchase
  adjustment
  refund
}

// Product Model
model Product {
  id          String        @id @default(cuid())
  spaceId     String
  sku         String
  name        String
  description String?
  price       Decimal       @db.Decimal(10, 2)
  costPrice   Decimal       @db.Decimal(10, 2)
  status      ProductStatus @default(draft)
  isPublished Boolean       @default(false)
  categoryId  String?
  tags        String[]      @default([])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  space          Space            @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  category       Category?        @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  images         ProductImage[]
  variants       ProductVariant[]
  inventoryItems InventoryItem[]
  orderItems     OrderItem[]

  @@unique([spaceId, sku])
  @@index([spaceId, status])
  @@index([spaceId, categoryId])
  @@index([spaceId, isPublished])
  @@index([spaceId, createdAt(sort: Desc)])
  @@map("products")
}

// Product Image Model
model ProductImage {
  id        String  @id @default(cuid())
  productId String
  url       String
  alt       String?
  isPrimary Boolean @default(false)
  sortOrder Int     @default(0)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

// Product Variant Model
model ProductVariant {
  id         String  @id @default(cuid())
  productId  String
  sku        String
  name       String
  price      Decimal @db.Decimal(10, 2)
  costPrice  Decimal @db.Decimal(10, 2)
  attributes Json    @default("{}")

  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventoryItems InventoryItem[]
  orderItems     OrderItem[]

  @@unique([productId, sku])
  @@index([productId])
  @@map("product_variants")
}

// Category Model (self-referential for hierarchy)
model Category {
  id          String  @id @default(cuid())
  spaceId     String
  name        String
  slug        String
  description String?
  parentId    String?
  sortOrder   Int     @default(0)

  space    Space      @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@unique([spaceId, slug])
  @@index([spaceId])
  @@index([spaceId, parentId])
  @@map("categories")
}

// Inventory Item Model
model InventoryItem {
  id        String  @id @default(cuid())
  spaceId   String
  productId String
  variantId String?
  location  String  @default("default")

  space     Space               @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  product   Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant   ProductVariant?     @relation(fields: [variantId], references: [id], onDelete: Cascade)
  movements InventoryMovement[]

  @@unique([spaceId, productId, variantId, location])
  @@index([spaceId])
  @@index([spaceId, productId])
  @@map("inventory_items")
}

// Inventory Movement Model
model InventoryMovement {
  id              String                 @id @default(cuid())
  inventoryItemId String
  type            MovementType
  quantity        Int
  reference       String?
  referenceType   MovementReferenceType?
  notes           String?
  costAtTime      Decimal?               @db.Decimal(10, 2)
  createdAt       DateTime               @default(now())

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  @@index([inventoryItemId])
  @@index([inventoryItemId, createdAt(sort: Desc)])
  @@index([reference, referenceType])
  @@map("inventory_movements")
}

// Customer Model
model Customer {
  id        String   @id @default(cuid())
  spaceId   String
  name      String
  email     String?
  phone     String?
  address   String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  space  Space   @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  orders Order[]

  @@unique([spaceId, email])
  @@index([spaceId])
  @@index([spaceId, name])
  @@index([spaceId, createdAt(sort: Desc)])
  @@map("customers")
}

// Order Model
model Order {
  id            String         @id @default(cuid())
  spaceId       String
  orderNumber   String
  customerId    String?
  source        OrderSource    @default(walk_in)
  paymentMethod PaymentMethod?
  status        OrderStatus    @default(pending)
  subtotal      Decimal        @db.Decimal(10, 2)
  tax           Decimal        @db.Decimal(10, 2) @default(0)
  discount      Decimal        @db.Decimal(10, 2) @default(0)
  total         Decimal        @db.Decimal(10, 2)
  totalCost     Decimal        @db.Decimal(10, 2) @default(0)
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  space    Space       @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  customer Customer?   @relation(fields: [customerId], references: [id], onDelete: SetNull)
  items    OrderItem[]

  @@unique([spaceId, orderNumber])
  @@index([spaceId, status])
  @@index([spaceId, createdAt(sort: Desc)])
  @@index([spaceId, customerId])
  @@index([spaceId, source])
  @@map("orders")
}

// Order Item Model
model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  variantId String?
  name      String
  sku       String
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)
  unitCost  Decimal @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Restrict)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// Commerce Settings Model (one per space)
model CommerceSettings {
  id                String   @id @default(cuid())
  spaceId           String   @unique
  currency          String   @default("USD")
  taxRate           Decimal  @db.Decimal(5, 2) @default(0)
  lowStockThreshold Int      @default(10)
  storeName         String   @default("")
  storeAddress      String   @default("")
  storePhone        String   @default("")
  paymentMethods    Json     @default("[]")
  updatedAt         DateTime @updatedAt

  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@map("commerce_settings")
}
